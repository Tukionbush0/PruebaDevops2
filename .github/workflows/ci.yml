name: ci


on:
push:
branches: [ main ]
pull_request:
branches: [ main ]


jobs:
build-and-push:
runs-on: ubuntu-latest
permissions:
contents: read
packages: write
id-token: write


steps:
- name: Checkout
uses: actions/checkout@v4


- name: Use Node.js 18
uses: actions/setup-node@v4
with:
node-version: '18'
cache: 'npm'


- name: Install dependencies
run: npm ci


- name: Run tests
run: npm test


- name: Run ESLint
run: npx eslint . --ext .js,.mjs,.cjs || true


- name: Snyk - test and monitor
uses: snyk/actions/node@master
with:
args: test
env:
SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}


- name: SonarCloud Scan
uses: SonarSource/sonarcloud-github-action@master
with:
args: >
-Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
-Dsonar.organization=${{ secrets.SONAR_ORG }}
env:
SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v2


- name: Login to DockerHub
uses: docker/login-action@v2
with:
username: ${{ secrets.DOCKERHUB_USERNAME }}
password: ${{ secrets.DOCKERHUB_PASSWORD }}


- name: Build and push Docker image
uses: docker/build-push-action@v5
with:
push: true
tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-node-app:latest
file: ./Dockerfile


- name: Verify image pushed
run: echo "Image pushed: ${{ secrets.DOCKERHUB_USERNAME }}/my-node-app:latest"
